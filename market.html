<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OceanStore - Store</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/U9aXSQB.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --cyan-primary: #75afca;
      --cyan-dark: #6095af;
      --cyan-light: #7dd3fc;
      --cyan-muted: #f0f9ff;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gray-50);
      min-height: 100vh;
      color: var(--gray-800);
    }

    #profile-header {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .profile-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px 6px 6px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid var(--gray-200);
      border-radius: 15px;
      cursor: pointer;
    }

    .profile-avatar { width: 34px; height: auto; }
    .profile-nick { font-weight: 600; font-size: 13px; color: var(--gray-800); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .profile-trigger svg { color: var(--gray-500); }

    .profile-dropdown {
      position: absolute; top: calc(100% + 8px); right: 0; width: 260px;
      background: white; border: 2px solid var(--gray-200); border-radius: 16px;
      padding: 8px 0; display: none;
    }
    .profile-dropdown.active { display: block; animation: fadeIn 0.2s ease; }

    .dropdown-user {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    }
    .dropdown-avatar { width: 40px; height: 42px; border-radius: 9px; border: 2px solid var(--cyan-primary); }
    .dropdown-user-nick { font-weight: 600; font-size: 15px; color: var(--gray-800); }
    .dropdown-user-points { font-size: 12px; color: var(--cyan-primary); font-weight: 500; }

    .dropdown-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 16px;
      font-size: 14px; color: var(--gray-700); text-decoration: none;
      width: 100%; background: none; border: none; cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }
    .dropdown-item:hover { background: var(--gray-50); color: var(--cyan-primary); }
    .dropdown-divider { height: 1px; background: var(--gray-200); margin: 8px 0; }
    .logout-btn { color: var(--danger); }
    .logout-btn:hover { background: #fee2e2; color: #dc2626; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toast {
      position: fixed; bottom: 24px; right: 24px; min-width: 300px;
      background: white; border: 2px solid var(--gray-200); border-radius: 12px;
      padding: 16px 20px; display: flex; align-items: center; gap: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.1); animation: slideUp 0.3s ease; z-index: 9999;
    }
    .toast.toast-success { border-color: var(--success); background: #d1fae5; }
    .toast.toast-error { border-color: var(--danger); background: #fee2e2; }
    .toast.toast-warning { border-color: var(--warning); background: #fef3c7; }
    .toast svg { width: 24px; height: 24px; flex-shrink: 0; }
    .toast span { font-size: 14px; color: var(--gray-800); flex: 1; }
    .toast-hide { animation: slideDown 0.3s ease forwards; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideDown {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(20px); }
    }

    .sidebar {
      position: fixed; left: 0; top: 0; width: 260px; height: 100vh;
      background: var(--white); border-right: 2px solid var(--gray-200); padding: 22px 0;
    }
    .sidebar-logo { padding: 0 18px 18px; border-bottom: 2px solid var(--gray-200); margin-bottom: 16px; }
    .sidebar-logo a { display: flex; align-items: center; gap: 12px; text-decoration: none; }
    .sidebar-logo-icon { width: 44px !important; height: 44px !important; display: flex !important; align-items: center !important; justify-content: center !important; }
    .sidebar-logo-icon img { width: 46px !important; height: 46px !important; object-fit: contain !important; transform: scale(1.1); }
    .sidebar-logo-text { font-size: 22px; font-weight: 700; color: var(--gray-800); }

    .nav-menu { list-style: none; padding: 0 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px;
      text-decoration: none; color: var(--gray-600); font-size: 14px; font-weight: 500;
      transition: all 0.2s ease;
    }
    .nav-link:hover { background: var(--gray-50); color: var(--gray-800); }
    .nav-link.active { background: var(--cyan-muted); color: var(--cyan-primary); }

    .main-content { margin-left: 260px; padding: 23px; min-height: 100vh; }

    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 32px; font-weight: 700; color: var(--gray-800); margin-bottom: 8px; }
    .page-header p { font-size: 15px; color: var(--gray-500); }

    .store-closed-banner {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 2px solid #fca5a5; border-radius: 16px; padding: 13px 18px;
      margin-bottom: 24px; display: none; align-items: center; gap: 13px;
    }
    .store-closed-banner svg { width: 28px; height: 28px; color: #dc2626; }
    .store-closed-banner p { font-size: 15px; color: #991b1b; font-weight: 500; }
    .store-closed-banner small { color: #7f1d1d; font-size: 13px; display: block; margin-top: 4px; }

    .points-bar {
      background: var(--white); border: 2px solid var(--gray-200); border-radius: 16px;
      padding: 20px 26px; margin-bottom: 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .points-info { display: flex; align-items: center; gap: 20px; }
    .points-icon {
      width: 56px; height: 56px; background: var(--cyan-muted); border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
    }
    .points-icon svg { width: 28px; height: 28px; color: var(--cyan-primary); }
    .points-text h3 { font-size: 14px; color: var(--gray-500); margin-bottom: 4px; text-transform: uppercase; }
    .points-text .value { font-size: 28px; font-weight: 700; color: var(--gray-800); }

    .points-progress { text-align: right; min-width: 300px; }
    .points-progress .label { font-size: 12px; color: var(--gray-500); margin-bottom: 4px; text-transform: uppercase; }
    .progress-bar { width: 100%; height: 8px; background: var(--gray-100); border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--cyan-primary), var(--cyan-light)); border-radius: 4px; transition: width 0.3s ease; }
    .progress-message { font-size: 12px; color: var(--gray-600); font-weight: 500; }
    .progress-message strong { color: var(--cyan-primary); }

    .queue-info {
      background: var(--cyan-muted); border: 2px solid var(--cyan-primary); border-radius: 16px;
      padding: 20px 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;
    }
    .queue-info svg { width: 32px; height: 32px; color: var(--cyan-primary); }
    .queue-info p { font-size: 16px; color: var(--gray-700); font-weight: 500; }
    .queue-info strong { color: var(--cyan-primary); font-size: 18px; }
    .queue-info small { font-size: 13px; color: var(--gray-500); display: block; margin-top: 4px; }

    .your-turn-info {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border: 2px solid #10b981; border-radius: 16px; padding: 20px 24px;
      margin-bottom: 24px; display: flex; align-items: center; gap: 16px;
    }
    .your-turn-info svg { width: 32px; height: 32px; color: #059669; }
    .your-turn-info p { font-size: 16px; color: #065f46; font-weight: 500; flex: 1; }
    .timer { font-family: monospace; font-size: 24px; font-weight: 700; color: #059669; }
    .btn-success { background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; }

    .category-section { margin-bottom: 48px; }
    .category-header { display: flex; align-items: center; gap: 13px; margin-bottom: 24px; }
    .category-badge { width: 48px; height: 48px; }
    .category-badge img { width: 100%; height: 100%; object-fit: contain; }
    .category-title h2 { font-size: 20px; font-weight: 700; color: var(--gray-800); }
    .category-title span { font-size: 13px; color: var(--gray-500); }

    .rewards-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;
    }
    .reward-card {
      background: var(--white); border: 2px solid var(--gray-200); border-radius: 16px;
      padding: 28px; display: flex; flex-direction: column; gap: 20px;
    }
    .reward-card.locked { opacity: 0.6; }
    .reward-card.disabled { pointer-events: none; opacity: 0.4; }
    .reward-icon { width: 56px; height: 56px; }
    .reward-icon img { width: 100%; height: 100%; object-fit: contain; }
    .reward-info h3 { font-size: 18px; font-weight: 600; color: var(--gray-800); margin-bottom: 6px; }
    .reward-info p { font-size: 13px; color: var(--gray-500); line-height: 1.6; }
    .reward-footer {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: auto; padding-top: 20px; border-top: 1px solid var(--gray-100);
    }
    .reward-cost {
      display: flex; align-items: center; gap: 8px; font-size: 20px; font-weight: 700; color: var(--cyan-primary);
    }
    .reward-cost svg { width: 20px; height: 20px; }

    .btn {
      font-family: 'Poppins', sans-serif; padding: 12px 24px; font-size: 13px; font-weight: 600;
      border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
    }
    .btn-primary { background: linear-gradient(135deg, var(--cyan-primary), var(--cyan-dark)); color: var(--white); }
    .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; opacity: 0.6; }
    .btn-locked { background: var(--gray-100); color: var(--gray-400); cursor: not-allowed; }

    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 2000; align-items: center; justify-content: center;
    }
    .modal.active { display: flex; animation: fadeIn 0.3s ease; }
    .modal-content {
      background: var(--white); border-radius: 24px; width: 100%; max-width: 450px;
      padding: 40px; text-align: center; border: 3px solid var(--cyan-primary);
    }
    .modal-icon {
      width: 80px; height: 80px; background: var(--cyan-muted); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;
    }
    .modal-icon svg { width: 40px; height: 40px; color: var(--cyan-primary); }
    .modal-content h2 { font-size: 28px; font-weight: 700; color: var(--gray-800); margin-bottom: 12px; }
    .modal-content p { color: var(--gray-600); margin-bottom: 24px; font-size: 16px; }
    .modal-position { background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .modal-position .number { font-size: 48px; font-weight: 800; color: var(--cyan-primary); line-height: 1; margin-bottom: 8px; }
    .modal-position .label { font-size: 14px; color: var(--gray-500); }
    .modal .btn { width: 100%; padding: 16px; font-size: 16px; }

    .loading { text-align: center; padding: 60px; color: var(--gray-500); font-size: 15px; grid-column: 1/-1; }

    .app-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 70px; background: #efefef14; backdrop-filter: blur(10px); border-bottom: 2px solid var(--gray-200); z-index: 998; padding: 0 20px; align-items: center; justify-content: space-between; }
    .app-header .header-logo { display: flex; align-items: center; gap: 10px; }
    .app-header .header-logo img { width: 40px; height: 40px; object-fit: contain; }
    .app-header .header-logo span { font-size: 20px; font-weight: 700; color: var(--gray-800); }
    .header-menu-toggle { background: none; color: black; border: none; width: 45px; height: 45px; font-size: 24px; cursor: pointer; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; transition: opacity 0.3s ease; }
    .sidebar-overlay.active { display: block; opacity: 1; }
    .sidebar-user-mobile { display: none; padding: 20px 16px; border-bottom: 2px solid var(--gray-200); margin-bottom: 16px; background: var(--gray-50); }
    .sidebar-user-mobile .user-info { display: flex; align-items: center; gap: 12px; }
    .sidebar-user-mobile .user-avatar { width: 45px; height: 47px; border-radius: 10px; border: 2px solid var(--cyan-primary); }
    .sidebar-user-mobile .user-nick { font-weight: 700; font-size: 16px; color: var(--gray-800); }
    .sidebar-user-mobile .user-points { font-size: 13px; color: var(--cyan-primary); font-weight: 600; }
    .sidebar-logout-mobile { display: none; margin-top: auto; padding: 16px; border-top: 2px solid var(--gray-200); }
    .sidebar-logout-mobile button { display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }

    @media (max-width: 768px) {
      .app-header { display: flex; }
      .sidebar { position: fixed; left: -280px; top: 0; width: 260px; height: 100vh; z-index: 1000; transition: left 0.3s ease; display: flex; flex-direction: column; padding-top: 0; }
      .sidebar.active { left: 0; }
      .sidebar-logo { display: none; }
      .sidebar-user-mobile { display: block; }
      .sidebar-logout-mobile { display: block; }
      .main-content { margin-left: 0; padding: 90px 16px 16px; }
      #profile-header { display: none; }
      .points-bar { flex-direction: column; gap: 16px; }
      .points-progress { min-width: 100%; }
      .queue-info, .your-turn-info { flex-direction: column; text-align: center; }
      .timer { margin-left: 0; }
      .rewards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-logo">
      <img src="https://i.imgur.com/U9aXSQB.png" alt="OceanStore">
      <span>OceanStore</span>
    </div>
    <button class="header-menu-toggle" id="menuToggle"><i class="ph ph-list"></i></button>
  </header>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar">
    <div class="sidebar-user-mobile"></div>
    <div class="sidebar-logo">
      <a href="overview.html">
        <div class="sidebar-logo-icon"><img src="https://i.imgur.com/U9aXSQB.png" alt="OceanStore"></div>
        <span class="sidebar-logo-text">OceanStore</span>
      </a>
    </div>
    <nav>
      <ul class="nav-menu">
        <li class="nav-item"><a href="overview.html" class="nav-link"><i class="ph ph-house"></i>Dashboard</a></li>
        <li class="nav-item"><a href="market.html" class="nav-link active"><i class="ph ph-storefront"></i>Loja</a></li>
        <li class="nav-item"><a href="redemption.html" class="nav-link"><i class="ph ph-ticket"></i>Resgates</a></li>
        <li class="nav-item" id="admin-nav-item" style="display: none;"><a href="painel.html" class="nav-link"><i class="ph ph-shield"></i>Admin</a></li>
        <li class="nav-item"><a href="#" class="nav-link"><i class="ph ph-fish"></i>Fortune Fish <span style="margin-left: auto; font-size: 10px; color: var(--gray-400);">Em breve</span></a></li>
      </ul>
      <div class="sidebar-logout-mobile"><button onclick="Auth.logout()"><i class="ph ph-sign-out"></i>Sair</button></div>
    </nav>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h1>Loja</h1>
      <p>Troque seus pontos por recompensas exclusivas.</p>
    </div>

    <div class="store-closed-banner" id="store-closed-banner">
      <svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm16-40a8,8,0,0,1-8,8,16,16,0,0,1-16-16V128a8,8,0,0,1,0-16,16,16,0,0,1,16,16v40A8,8,0,0,1,144,176ZM112,84a12,12,0,1,1,12,12A12,12,0,0,1,112,84Z"></path></svg>
      <div><p>A loja está fechada no momento.</p><small>Próxima abertura: <span id="next-open-date">Carregando...</span></small></div>
    </div>

    <div class="queue-info" id="queue-info" style="display: none;">
      <svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H136v48a8,8,0,0,1-16,0V136H72a8,8,0,0,1,0-16h48V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path></svg>
      <p id="queue-text">Aguardando sua vez na fila... Sua posição: <strong id="user-position">#0</strong></p>
    </div>

    <div class="your-turn-info" id="your-turn-info" style="display: none;">
      <svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H136v48a8,8,0,0,1-16,0V136H72a8,8,0,0,1,0-16h48V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path></svg>
      <div style="flex: 1;"><p>É a sua vez de resgatar! Você tem <strong>30 minutos</strong>.</p></div>
      <div class="timer" id="turn-timer"></div>
      <button class="btn btn-success" onclick="completeTurn()">Pronto, escolhi!</button>
    </div>

    <div class="points-bar">
      <div class="points-info">
        <div class="points-icon"><svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H136v48a8,8,0,0,1-16,0V136H72a8,8,0,0,1,0-16h48V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path></svg></div>
        <div class="points-text"><h3>Seus pontos</h3><div class="value" id="user-points">0</div></div>
      </div>
      <div class="points-progress">
        <div class="label">Progresso para Diamante</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
        <div class="progress-message" id="progress-message"></div>
      </div>
    </div>

    <div id="rewards-container"><div class="loading">Carregando recompensas...</div></div>
  </main>

  <div class="modal" id="queue-modal">
    <div class="modal-content">
      <div class="modal-icon"><svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H136v48a8,8,0,0,1-16,0V136H72a8,8,0,0,1,0-16h48V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path></svg></div>
      <h2>Aguardando na fila</h2>
      <p>Você está na fila de resgate. Aguarde sua vez para fazer um resgate.</p>
      <div class="modal-position"><div class="number" id="modal-position">#0</div><div class="label">Sua posição na fila</div></div>
      <button class="btn btn-primary" onclick="document.getElementById('queue-modal').classList.remove('active')">ENTENDI</button>
    </div>
  </div>

    <script src="js/session.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/profile-header.js"></script>
  <script>
    (function() { if (!SessionManager.isAuthenticated()) window.location.href = 'index.html'; })();
  </script>
  <script>
    if (!SessionManager.isAuthenticated()) {
      window.location.replace('index.html');
    } else {
      (async function() {
        if (!(await Auth.checkAuth())) return;
        
        ProfileHeader.init();

        const user = SessionManager.getUser();
        let currentPoints = user.points;
        let storeOpen = false;
        let timerInterval = null;
        let updateInterval = null;

        const categoryImages = {
          diamond: 'https://i.imgur.com/CfUL0Y2.png',
          gold: 'https://i.imgur.com/mrX2SFE.png',
          silver: 'https://i.imgur.com/gncsj9O.png',
          bronze: 'https://i.imgur.com/dtxKLpc.png'
        };

        function updateProgressMessage(points) {
          const messageEl = document.getElementById('progress-message');
          if (!messageEl) return;
          if (points >= 100) messageEl.innerHTML = '<strong>Diamante!</strong> Você pode resgatar qualquer recompensa!';
          else if (points >= 70) messageEl.innerHTML = `Faltam <strong>${100 - points} pontos</strong> para Diamante`;
          else if (points >= 50) messageEl.innerHTML = `Faltam <strong>${70 - points} pontos</strong> para Ouro`;
          else if (points >= 20) messageEl.innerHTML = `Faltam <strong>${50 - points} pontos</strong> para Prata`;
          else messageEl.innerHTML = `Faltam <strong>${20 - points} pontos</strong> para Bronze`;
        }

        function startTimer() {
          if (timerInterval) clearInterval(timerInterval);

          const timerEl = document.getElementById('turn-timer');
          if (timerEl) timerEl.textContent = '30:00';
          
          timerInterval = setInterval(async () => {
            try {
              const remainingSeconds = await DB.store.getRemainingTime();
              const mins = Math.floor(remainingSeconds / 60);
              const secs = remainingSeconds % 60;
              const timerEl = document.getElementById('turn-timer');
              if (timerEl) timerEl.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;

              if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                await DB.redemptions.processNextTurn();
                await updateUI();
                Toast.show('Seu tempo acabou! Passando para o próximo...', 'warning');
              }
            } catch (error) { console.error('Erro no timer:', error); }
          }, 1000);
        }

        async function loadRewards() {
          try {
            const rewards = await DB.rewards.getAll();
            const container = document.getElementById('rewards-container');
            if (!container) return;
            
            if (!rewards || rewards.length === 0) {
              container.innerHTML = '<div class="loading">Nenhuma recompensa disponível</div>';
              return;
            }

            const grouped = { diamond: [], gold: [], silver: [], bronze: [] };
            rewards.forEach(r => { if (grouped[r.category]) grouped[r.category].push(r); });

            let html = '';
            for (const [category, catRewards] of Object.entries(grouped)) {
              if (catRewards.length === 0) continue;

              let categoryName = '', minPoints = 0;
              switch(category) {
                case 'diamond': categoryName = 'Diamante'; minPoints = 100; break;
                case 'gold': categoryName = 'Ouro'; minPoints = 70; break;
                case 'silver': categoryName = 'Prata'; minPoints = 50; break;
                case 'bronze': categoryName = 'Bronze'; minPoints = 20; break;
              }

              html += `<div class="category-section"><div class="category-header"><div class="category-badge"><img src="${categoryImages[category]}" alt="${categoryName}"></div><div class="category-title"><h2>${categoryName}</h2><span>a partir de ${minPoints} pontos</span></div></div><div class="rewards-grid">`;

              catRewards.forEach(reward => {
                const canAfford = currentPoints >= reward.cost;
                const canRedeem = storeOpen && canAfford;
                
                html += `<div class="reward-card ${!canAfford ? 'locked' : ''} ${!storeOpen ? 'disabled' : ''}">
                  <div class="reward-icon">${reward.image_url ? `<img src="${reward.image_url}" alt="${reward.name}">` : '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M216,72H178.83L200.3,35.5a8,8,0,0,0-13.7-8.27L164.41,64H91.59L69.4,27.23a8,8,0,1,0-13.7,8.27L77.17,72H40A16,16,0,0,0,24,88V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V88A16,16,0,0,0,216,72Z"></path></svg>'}</div>
                  <div class="reward-info"><h3>${reward.name}</h3><p>${reward.description || 'Recompensa exclusiva'}</p></div>
                  <div class="reward-footer"><div class="reward-cost"><svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H136v48a8,8,0,0,1-16,0V136H72a8,8,0,0,1,0-16h32V88a8,8,0,0,1,16,0v32h32A8,8,0,0,1,192,128Z"></path></svg>${reward.cost}</div>
                  <button class="btn ${canRedeem ? 'btn-primary' : 'btn-locked'}" onclick="purchase('${reward.id}', '${reward.name.replace(/'/g, "\\'")}', ${reward.cost})" ${!canRedeem ? 'disabled' : ''}>${!storeOpen ? 'Loja fechada' : !canAfford ? 'Pontos insuficientes' : 'Resgatar'}</button></div></div>`;
              });
              html += `</div></div>`;
            }
            container.innerHTML = html;
          } catch (error) {
            console.error('Erro ao carregar recompensas:', error);
            const container = document.getElementById('rewards-container');
            if (container) container.innerHTML = '<div class="loading">Erro ao carregar recompensas</div>';
          }
        }

        window.purchase = async function(id, name, cost) {
          if (!storeOpen) { Toast.show('A loja está fechada no momento', 'error'); return; }

          const currentTurn = await DB.redemptions.getCurrentTurn();
          if (!currentTurn) { Toast.show('Ninguém está na vez no momento.', 'error'); return; }
          if (currentTurn.id !== user.id) {
            const queue = await DB.redemptions.getQueue();
            const position = queue.findIndex(u => u.id === user.id) + 1;
            Toast.show(`Não é sua vez! Sua posição na fila é: #${position}. Vez atual: ${currentTurn.nick}`, 'error');
            return;
          }

          if (currentPoints < cost) { Toast.show('Pontos insuficientes', 'error'); return; }

          const reward = await DB.rewards.getById(id);
          if (!reward) { Toast.show('Recompensa não encontrada', 'error'); return; }

          const userRedemptions = await DB.redemptions.getByUser(user.id);
          const categoryRedemptions = userRedemptions.filter(r => r.reward_category === reward.category && r.status === 'approved').length;
          if (categoryRedemptions >= 1) { Toast.show(`Você já resgatou um item da categoria ${reward.category}! Limite: 1 por categoria`, 'error'); return; }
          
          if (!confirm(`Deseja resgatar "${name}" por ${cost} pontos?`)) return;

          try {
            const redemption = { user_id: user.id, reward_id: id, reward_name: name, reward_category: reward.category, cost: cost, status: 'pending', created_at: new Date().toISOString() };
            await DB.redemptions.create(redemption);

            const newPoints = currentPoints - cost;
            await DB.users.update(user.id, { points: newPoints });
            
            user.points = newPoints;
            currentPoints = newPoints;
            SessionManager.setUser(user);
            ProfileHeader.update();

            const pointsEl = document.getElementById('user-points');
            if (pointsEl) pointsEl.textContent = newPoints;
            
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) progressFill.style.width = Math.min((newPoints / 100) * 100, 100) + '%';
            
            updateProgressMessage(newPoints);

            Toast.show('Resgate feito com sucesso!', 'success');

            await DB.redemptions.processNextTurn();
            await updateUI();
            await loadRewards();
          } catch (error) {
            console.error('Erro ao resgatar:', error);
            Toast.show('Erro ao processar resgate', 'error');
          }
        };

        window.completeTurn = async function() {
          try {
            const currentTurn = await DB.redemptions.getCurrentTurn();
            if (!currentTurn) { Toast.show('Ninguém está na vez no momento', 'error'); return; }
            if (currentTurn.id !== user.id) { Toast.show('Não é sua vez!', 'error'); return; }

            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            await DB.redemptions.processNextTurn();
            Toast.show('Vez finalizada! Passando para o próximo...', 'success');
            await updateUI();
          } catch (error) {
            console.error('Erro ao completar turno:', error);
            Toast.show('Erro ao finalizar turno', 'error');
          }
        };

        async function updateUI() {
          try {
            const status = await DB.store.getStatus();
            storeOpen = status.is_open;
            
            const banner = document.getElementById('store-closed-banner');
            const queueInfo = document.getElementById('queue-info');
            const yourTurnInfo = document.getElementById('your-turn-info');
            const nextOpenDate = document.getElementById('next-open-date');
            const modalPosition = document.getElementById('modal-position');
            const userPosition = document.getElementById('user-position');

            if (status.next_open_date && nextOpenDate) {
              const date = new Date(status.next_open_date);
              nextOpenDate.textContent = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' (dia 5)';
            } else if (nextOpenDate) {
              const nextDate = await DB.store.calculateNextOpenDate();
              const date = new Date(nextDate);
              nextOpenDate.textContent = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' (dia 5)';
            }

            if (!storeOpen) {
              if (banner) banner.style.display = 'flex';
              if (queueInfo) queueInfo.style.display = 'none';
              if (yourTurnInfo) yourTurnInfo.style.display = 'none';
              if (timerInterval) clearInterval(timerInterval);
              if (modalPosition) modalPosition.textContent = '#0';
              if (userPosition) userPosition.textContent = '#0';
              return;
            }

            if (banner) banner.style.display = 'none';

            const queue = await DB.redemptions.getQueue();
            const position = queue.findIndex(u => u.id === user.id) + 1;
            const currentTurn = await DB.redemptions.getCurrentTurn();

            if (modalPosition) modalPosition.textContent = `#${position || 0}`;
            if (userPosition) userPosition.textContent = `#${position || 0}`;

            if (currentTurn && currentTurn.id === user.id) {
              if (queueInfo) queueInfo.style.display = 'none';
              if (yourTurnInfo) yourTurnInfo.style.display = 'flex';
              startTimer();
            } 
            else if (position > 0) {
              if (queueInfo) {
                queueInfo.style.display = 'flex';
                const queueText = document.getElementById('queue-text');
                if (queueText) {
                  queueText.innerHTML = currentTurn 
                    ? `Aguardando sua vez... Sua posição: <strong>#${position}</strong><br><small>Vez atual: ${currentTurn.nick}</small>`
                    : `Aguardando sua vez... Sua posição: <strong>#${position}</strong>`;
                }
              }
              if (yourTurnInfo) yourTurnInfo.style.display = 'none';
              if (timerInterval) clearInterval(timerInterval);
            } 
            else {
              if (queueInfo) queueInfo.style.display = 'none';
              if (yourTurnInfo) yourTurnInfo.style.display = 'none';
              if (timerInterval) clearInterval(timerInterval);
            }

            await loadRewards();
          } catch (error) {
            console.error('Erro ao atualizar UI:', error);
          }
        }

        const pointsEl = document.getElementById('user-points');
        if (pointsEl) pointsEl.textContent = currentPoints;
        
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) progressFill.style.width = Math.min((currentPoints / 100) * 100, 100) + '%';
        
        updateProgressMessage(currentPoints);

        await updateUI();

        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(async () => {
          await DB.store.checkAutoClose();
          await DB.store.checkAndOpenNext();
          await updateUI();
        }, 5000);
      })();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuToggle && sidebar && overlay) {
        menuToggle.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuToggle.querySelector('i');
          if (icon) icon.className = sidebar.classList.contains('active') ? 'ph ph-x' : 'ph ph-list';
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuToggle.querySelector('i');
          if (icon) icon.className = 'ph ph-list';
        });
      }

      const user = SessionManager.getUser();
      const adminNavItem = document.getElementById('admin-nav-item');
      if (adminNavItem && user && user.isAdmin) adminNavItem.style.display = 'block';
    });
  </script>
</body>
</html>